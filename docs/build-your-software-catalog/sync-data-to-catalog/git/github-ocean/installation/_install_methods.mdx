import Tabs from "@theme/Tabs"
import TabItem from "@theme/TabItem"
import CodeBlock from '@theme/CodeBlock';
import AdvancedConfig from '../../../../../generalTemplates/\_ocean_advanced_configuration_note.md'
import PortApiRegionTip from "/docs/generalTemplates/\_port_region_parameter_explanation_template.md"
import Prerequisites from "../../../templates/\_ocean_helm_prerequisites_block.mdx"
import CiInstallMethod from "./\_ci_install.mdx"
import DockerInstallMethod from "./_docker_install.mdx"
import ParametersTable from "./_parameters_table.jsx"
import Base64Tip from "./\_base_64_tip.mdx"

<Tabs groupId="installation-methods" queryString="installation-methods">

<TabItem value="real-time-self-hosted" label="Kubernetes">

Using this installation option means that the integration will be able to update Port in real time using webhooks.

<h2>Prerequisites</h2>

<Prerequisites />

For details about the available parameters for the installation, see the table below.

<Tabs groupId="deploy" queryString="deploy">
<TabItem value="helm" label="Helm" default>
To install the integration using Helm:

Add Port's Helm chart repository:
```showLineNumbers
helm repo add --force-update port-labs https://port-labs.github.io/helm-charts
```

Install the Helm chart:
  {props.setupName == "app" ? (
    <CodeBlock language="bash" showLineNumbers>
{`helm upgrade --install github-ocean port-labs/port-ocean \\
	--set port.clientId="<PORT_CLIENT_ID>"  \\
	--set port.clientSecret="<PORT_CLIENT_SECRET>"  \\
	--set port.baseUrl="https://api.port.io"  \\
	--set integration.identifier="github-ocean"  \\
	--set integration.type="github-ocean"  \\
	--set integration.eventListener.type="POLLING"  \\
	--set integration.config.githubOrganization=<GITHUB_ORGANIZATION>  \\
	--set integration.config.githubHost=<GITHUB_HOST>  \\
	--set integration.config.githubAppId=<GITHUB_APP_ID> \\
	--set integration.secrets.githubAppPrivateKey=<BASE_64_ENCODED_PRIVATEKEY> \\
	--set integration.version="1.0.5-beta"  \\
	--set initializePortResources=true  \\
	--set sendRawDataExamples=true  \\
	--set scheduledResyncInterval=360`}
    </CodeBlock>
  ) : (
    <CodeBlock language="bash" showLineNumbers>
{`helm upgrade --install github-ocean port-labs/port-ocean \\
	--set port.clientId="<PORT_CLIENT_ID>"  \\
	--set port.clientSecret="<PORT_CLIENT_SECRET>"  \\
	--set port.baseUrl="https://api.port.io"  \\
	--set integration.identifier="github-ocean"  \\
	--set integration.type="github-ocean"  \\
	--set integration.eventListener.type="POLLING"  \\
	--set integration.config.githubOrganization=<GITHUB_ORGANIZATION>  \\
	--set integration.config.githubHost=<GITHUB_HOST>  \\
	--set integration.secrets.githubToken="<GITHUB_PAT>"  \\
	--set integration.version="1.0.5-beta"  \\
	--set initializePortResources=true  \\
	--set sendRawDataExamples=true  \\
	--set scheduledResyncInterval=360`}
    </CodeBlock>
  )}

<PortApiRegionTip/>

</TabItem>

<TabItem value="argocd" label="ArgoCD" default>
To install the integration using ArgoCD:

1. Create a `values.yaml` file in `argocd/my-ocean-github-integration` in your git repository with the content:

:::note
Be sure to replace the `<GITHUB_TOKEN>` and `<GITHUB_ORGANIZATION>` placeholders with your actual values. If you are using a self-hosted GitHub instance, update the `githubHost` value to point to your instance.
:::

```yaml showLineNumbers
initializePortResources: true
scheduledResyncInterval: 120
integration:
  identifier: my-ocean-github-integration
  type: github-ocean
  version: 1.0.5-beta
  eventListener:
    type: POLLING
  config:
    githubHost: https://api.github.com # Or your self-hosted GitHub URL
    githubOrganization: <GITHUB_ORGANIZATION> # your github organization, e.g port-labs
  secrets:
    githubToken: <GITHUB_TOKEN>
```

<br/>
2. Install the `my-ocean-github-integration` ArgoCD Application by creating the following `my-ocean-github-integration.yaml` manifest:
:::note
Remember to replace the placeholders for `YOUR_PORT_CLIENT_ID` `YOUR_PORT_CLIENT_SECRET` and `YOUR_GIT_REPO_URL`.

Multiple sources ArgoCD documentation can be found [here](https://argo-cd.readthedocs.io/en/stable/user-guide/multiple_sources/#helm-value-files-from-external-git-repository).
:::

<details>
  <summary>ArgoCD Application</summary>

```yaml showLineNumbers
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-ocean-github-integration
  namespace: argocd
spec:
  destination:
    namespace: my-ocean-github-integration
    server: https://kubernetes.default.svc
  project: default
  sources:
  - repoURL: 'https://port-labs.github.io/helm-charts/'
    chart: port-ocean
    targetRevision: 0.8.5
    helm:
      valueFiles:
      - $values/argocd/my-ocean-github-integration/values.yaml
      // highlight-start
      parameters:
        - name: port.clientId
          value: <YOUR_PORT_CLIENT_ID>
        - name: port.clientSecret
          value: <YOUR_PORT_CLIENT_SECRET>
        - name: port.baseUrl
          value: https://api.getport.io
      // highlight-end
  // highlight-start
  - repoURL: <YOUR_GIT_REPO_URL>
    targetRevision: main
    ref: values
  // highlight-end
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
```

<PortApiRegionTip/>
</details>
<br/>

1. Apply your application manifest with `kubectl`:

```bash
kubectl apply -f my-ocean-github-integration.yaml
```

</TabItem>


</Tabs>

{props.setupName == "app" && <Base64Tip />}

This table summarizes the available parameters for the installation.

<ParametersTable showingApp={props.setupName == "app"} />

<br/>

<AdvancedConfig/>

</TabItem>

<TabItem value="docker" label="Docker" default>
    <DockerInstallMethod showingApp={props.setupName == "app"} />
</TabItem>

{props.setupName != "app" && 
<TabItem value="one-time-ci" label="Scheduled (CI)">
<CiInstallMethod />
</TabItem>}
</Tabs>

### Enabling live-events

To enable live-events we only have to set the `base_url` argument, this allows our integration to configure a webhook on Github. 

<Tabs groupId="liveEvents" queryString="live-events">
    <TabItem value="kubernetes" label="Kubernetes">
      When you install the integration using Helm, a Kubernetes Service is created. To receive webhooks from GitHub, you need to expose this service to the internet. The `port-ocean` Helm chart provides a simple way to do this by creating a Kubernetes Ingress resource.

      #### Prerequisites

      You must have an [Ingress controller](https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/) installed in your cluster. If you don't have one, you can install the popular [NGINX Ingress Controller](https://kubernetes.github.io/ingress-nginx/deploy/).

      #### Helm Configuration

      To enable live events, you need to update your Helm release with the following configurations:

      1.  **Event Listener Type**: Set to `WEBHOOK` to enable the integration to listen for incoming webhook events.
      2.  **Ingress Configuration**: Enable the creation of an Ingress resource and specify the hostname that will be used to access the integration from the internet.
      3.  **Base URL**: Provide the integration with its public URL. This is used to register the webhook in GitHub.

      Here is an example of how to set these parameters in your `helm upgrade --install` command. Make sure to replace `<YOUR_DOMAIN>` with your actual public domain name.

      A full example based on the installation command:
        {props.setupName == "app" ? (
          <CodeBlock language="bash" showLineNumbers>
      {`helm upgrade --install github-ocean port-labs/port-ocean \\
      	--set port.clientId="<PORT_CLIENT_ID>"  \\
      	--set port.clientSecret="<PORT_CLIENT_SECRET>"  \\
      	--set port.baseUrl="https://api.port.io"  \\
      	--set integration.identifier="github-ocean"  \\
      	--set integration.type="github-ocean"  \\
      	--set integration.eventListener.type="WEBHOOK"  \\
      	--set integration.config.baseUrl="https://<YOUR_DOMAIN>" \\
      	--set integration.config.githubOrganization=<GITHUB_ORGANIZATION>  \\
      	--set integration.config.githubHost=<GITHUB_HOST>  \\
      	--set integration.config.githubAppId=<GITHUB_APP_ID> \\
      	--set integration.secrets.githubAppPrivateKey=<BASE_64_ENCODED_PRIVATEKEY> \\
      	--set integration.version="1.0.5-beta"  \\
      	--set initializePortResources=true  \\
      	--set sendRawDataExamples=true  \\
      	--set scheduledResyncInterval=360 \\
      	--set ingress.enabled=true \\
      	--set ingress.host="<YOUR_DOMAIN>"`}
          </CodeBlock>
        ) : (
          <CodeBlock language="bash" showLineNumbers>
      {`helm upgrade --install github-ocean port-labs/port-ocean \\
      	--set port.clientId="<PORT_CLIENT_ID>"  \\
      	--set port.clientSecret="<PORT_CLIENT_SECRET>"  \\
      	--set port.baseUrl="https://api.port.io"  \\
      	--set integration.identifier="github-ocean"  \\
      	--set integration.type="github-ocean"  \\
      	--set integration.eventListener.type="WEBHOOK"  \\
      	--set integration.config.baseUrl="https://<YOUR_DOMAIN>" \\
      	--set integration.config.githubOrganization=<GITHUB_ORGANIZATION>  \\
      	--set integration.config.githubHost=<GITHUB_HOST>  \\
      	--set integration.secrets.githubToken="<GITHUB_PAT>"  \\
      	--set integration.version="1.0.5-beta"  \\
      	--set initializePortResources=true  \\
      	--set sendRawDataExamples=true  \\
      	--set scheduledResyncInterval=360 \\
      	--set ingress.enabled=true \\
      	--set ingress.host="<YOUR_DOMAIN>"`}
          </CodeBlock>
        )}

      #### Securing with TLS

      For production environments, it is highly recommended to secure your Ingress with TLS. If you are using `cert-manager`, you can automate the provisioning of TLS certificates by adding annotations to the Ingress.

      You can specify the `ingress.className` and `ingress.annotations` in your Helm command:

      <CodeBlock language="bash" showLineNumbers>
      {`helm upgrade --install github-ocean port-labs/port-ocean \\
          # ... other parameters
          --set ingress.enabled=true \\
          --set ingress.host="<YOUR_DOMAIN>" \\
          --set ingress.className="nginx" \\
          --set-string ingress.annotations.'cert-manager\\.io/cluster-issuer'="letsencrypt-prod"`}
      </CodeBlock>

      #### Verify Ingress

      After applying the changes, you can check the status of your Ingress. The Ingress resource will be named after your Helm release (e.g., `github-ocean`):

      <CodeBlock language="bash">
      {`kubectl get ingress github-ocean`}
      </CodeBlock>

      The output should show the public IP address or hostname in the `ADDRESS` column. This is the URL you will use for GitHub webhooks.

      When you set the `integration.config.baseUrl`, Ocean will attempt to automatically create the webhook in GitHub for you.
    </TabItem>

    <TabItem value="docker" label="Docker">
      # AI! can you improve the docs in this tab item? make it more comprehensible and more succint, I have added a `contributing.md` file which contains a style guide
      To enable live-events when the integration is directly run with Docker, we need to configure our deployment environment to proxy requests to the running container by configuring a reverse proxy.

      :::tip

      <details>
        <summary>Local Testing</summary>

        When running the docker image locally, you can get an integration endpoint by using [Ngrok](https://ngrok.com/), simply start a tunnel to port 8000 with:
        ```sh showLineNumbers
          ngrok http 8000
        ```
        This would produce an output like this:

        ```
          ngrok                                (Ctl+C to quit)

          ngrok does not support a dynamic, color terminal UI on solaris.
          Access the web interface for connection and tunnel status.

          Version                       3.11.0
          Region                        Auto (lowest latency) (auto)
          Web Interface                 http://127.0.0.1:4040
      ```
       Open the "Web interface" in your browser to see your base url, it is in the format:
        
      ```
      https://c69626931a59.ngrok-free.app
      ```
      
      Now we can run the docker container using this as our `OCEAN_BASE_URL`

      ```sh showLineNumbers
      docker run \
      -e OCEAN__BASE_URL=https://c69626931a59.ngrok-free.app \ #replace with your ngrok url
      # ..other docker variables from the Docker deploy step.
      -p 8000:8000 \
      ghcr.io/port-labs/port-ocean-github-ocean:1.0.5-beta
      ```
      </details>

      :::

      #### Setting up with Nginx

      If you are deploying the integration on a server with Nginx, you can configure it as a reverse proxy to expose the integration to the internet.

      ##### 1. Configure Nginx
      Create a new Nginx configuration file at `/etc/nginx/sites-available/github-ocean.conf`. This will forward requests from `github-ocean.example-domain.com` to the integration container on port `8000`.

      <CodeBlock language="nginx" title="/etc/nginx/sites-available/github-ocean.conf">
{`server {
    listen 80;
    server_name github-ocean.example-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}`}
      </CodeBlock>

      :::note
      For a production setup, it is highly recommended to also configure SSL/TLS for your domain. You can use a service like [Let's Encrypt](https://letsencrypt.org/) to get free SSL certificates.
      :::

      ##### 2. Enable the Site and Restart Nginx
      Enable the new site by creating a symbolic link, then test the configuration and restart Nginx.

      <CodeBlock language="bash">
{`sudo ln -s /etc/nginx/sites-available/github-ocean.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx`}
      </CodeBlock>

      ##### 3. Run the Docker Container
      Finally, run the integration's Docker container. Set the `OCEAN__BASE_URL` to your public domain and bind the container's port `8000` to `127.0.0.1:8000` on the host. This ensures it's only accessible via the Nginx proxy.

      <CodeBlock language="bash" showLineNumbers>
{`docker run \\
  -e OCEAN__BASE_URL="http://github-ocean.example-domain.com" \\
  # ... other docker variables from the Docker deploy step
  -p 8000:8000 \\
  ghcr.io/port-labs/port-ocean-github-ocean:1.0.5-beta`}
      </CodeBlock>
    </TabItem>
</Tabs>
