import Tabs from "@theme/Tabs"
import TabItem from "@theme/TabItem"
import CodeBlock from '@theme/CodeBlock';
import AdvancedConfig from '../../../../../generalTemplates/\_ocean_advanced_configuration_note.md'
import PortApiRegionTip from "/docs/generalTemplates/\_port_region_parameter_explanation_template.md"
import Prerequisites from "../../../templates/\_ocean_helm_prerequisites_block.mdx"
import CiInstallMethod from "./\_ci_install.mdx"
import DockerInstallMethod from "./_docker_install.mdx"
import ParametersTable from "./_parameters_table.jsx"
import Base64Tip from "./\_base_64_tip.mdx"

<Tabs groupId="installation-methods" queryString="installation-methods">

<TabItem value="real-time-self-hosted" label="Kubernetes">

Using this installation option means that the integration will be able to update Port in real time using webhooks.

<h2>Prerequisites</h2>

<Prerequisites />

For details about the available parameters for the installation, see the table below.

<Tabs groupId="deploy" queryString="deploy">
<TabItem value="helm" label="Helm" default>
To install the integration using Helm:

Add Port's Helm chart repository:
```showLineNumbers
helm repo add --force-update port-labs https://port-labs.github.io/helm-charts
```

Install the Helm chart:
  {props.setupName == "app" ? (
    <CodeBlock language="bash" showLineNumbers>
{`helm upgrade --install github-ocean port-labs/port-ocean \\
	--set port.clientId="<PORT_CLIENT_ID>"  \\
	--set port.clientSecret="<PORT_CLIENT_SECRET>"  \\
	--set port.baseUrl="https://api.port.io"  \\
	--set integration.identifier="github-ocean"  \\
	--set integration.type="github-ocean"  \\
	--set integration.eventListener.type="POLLING"  \\
	--set integration.config.githubOrganization=<GITHUB_ORGANIZATION>  \\
	--set integration.config.githubHost=<GITHUB_HOST>  \\
	--set integration.config.githubAppId=<GITHUB_APP_ID> \\
	--set integration.secrets.githubAppPrivateKey=<BASE_64_ENCODED_PRIVATEKEY> \\
	--set integration.version="1.0.5-beta"  \\
	--set initializePortResources=true  \\
	--set sendRawDataExamples=true  \\
	--set scheduledResyncInterval=360`}
    </CodeBlock>
  ) : (
    <CodeBlock language="bash" showLineNumbers>
{`helm upgrade --install github-ocean port-labs/port-ocean \\
	--set port.clientId="<PORT_CLIENT_ID>"  \\
	--set port.clientSecret="<PORT_CLIENT_SECRET>"  \\
	--set port.baseUrl="https://api.port.io"  \\
	--set integration.identifier="github-ocean"  \\
	--set integration.type="github-ocean"  \\
	--set integration.eventListener.type="POLLING"  \\
	--set integration.config.githubOrganization=<GITHUB_ORGANIZATION>  \\
	--set integration.config.githubHost=<GITHUB_HOST>  \\
	--set integration.secrets.githubToken="<GITHUB_PAT>"  \\
	--set integration.version="1.0.5-beta"  \\
	--set initializePortResources=true  \\
	--set sendRawDataExamples=true  \\
	--set scheduledResyncInterval=360`}
    </CodeBlock>
  )}

<PortApiRegionTip/>

</TabItem>

<TabItem value="argocd" label="ArgoCD" default>
To install the integration using ArgoCD:

1. Create a `values.yaml` file in `argocd/my-ocean-github-integration` in your git repository with the content:

:::note
Be sure to replace the `<GITHUB_TOKEN>` and `<GITHUB_ORGANIZATION>` placeholders with your actual values. If you are using a self-hosted GitHub instance, update the `githubHost` value to point to your instance.
:::

```yaml showLineNumbers
initializePortResources: true
scheduledResyncInterval: 120
integration:
  identifier: my-ocean-github-integration
  type: github-ocean
  version: 1.0.5-beta
  eventListener:
    type: POLLING
  config:
    githubHost: https://api.github.com # Or your self-hosted GitHub URL
    githubOrganization: <GITHUB_ORGANIZATION> # your github organization, e.g port-labs
  secrets:
    githubToken: <GITHUB_TOKEN>
```

<br/>
2. Install the `my-ocean-github-integration` ArgoCD Application by creating the following `my-ocean-github-integration.yaml` manifest:
:::note
Remember to replace the placeholders for `YOUR_PORT_CLIENT_ID` `YOUR_PORT_CLIENT_SECRET` and `YOUR_GIT_REPO_URL`.

Multiple sources ArgoCD documentation can be found [here](https://argo-cd.readthedocs.io/en/stable/user-guide/multiple_sources/#helm-value-files-from-external-git-repository).
:::

<details>
  <summary>ArgoCD Application</summary>

```yaml showLineNumbers
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-ocean-github-integration
  namespace: argocd
spec:
  destination:
    namespace: my-ocean-github-integration
    server: https://kubernetes.default.svc
  project: default
  sources:
  - repoURL: 'https://port-labs.github.io/helm-charts/'
    chart: port-ocean
    targetRevision: 0.8.5
    helm:
      valueFiles:
      - $values/argocd/my-ocean-github-integration/values.yaml
      // highlight-start
      parameters:
        - name: port.clientId
          value: <YOUR_PORT_CLIENT_ID>
        - name: port.clientSecret
          value: <YOUR_PORT_CLIENT_SECRET>
        - name: port.baseUrl
          value: https://api.getport.io
      // highlight-end
  // highlight-start
  - repoURL: <YOUR_GIT_REPO_URL>
    targetRevision: main
    ref: values
  // highlight-end
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
```

<PortApiRegionTip/>
</details>
<br/>

1. Apply your application manifest with `kubectl`:

```bash
kubectl apply -f my-ocean-github-integration.yaml
```

</TabItem>


</Tabs>

{props.setupName == "app" && <Base64Tip />}

This table summarizes the available parameters for the installation.

<ParametersTable showingApp={props.setupName == "app"} />

<br/>

<AdvancedConfig/>

</TabItem>

<TabItem value="docker" label="Docker" default>
    <DockerInstallMethod showingApp={props.setupName == "app"} />
</TabItem>

{props.setupName != "app" && 
<TabItem value="one-time-ci" label="Scheduled (CI)">
<CiInstallMethod />
</TabItem>}
</Tabs>

### Enabling live-events

To enable live-events we only have to set the `base_url` argument, this allows our integration to configure a webhook on Github. 

<Tabs groupId="liveEvents" queryString="live-events">
    <TabItem value="kubernetes" label="Kubernetes">

      When you install the integration using Helm, a Kubernetes Service is created. This service exposes the integration within the cluster. To receive webhooks from GitHub, you need to expose this service to the internet. A Kubernetes Ingress is the standard way to do this.

      Here is a step-by-step guide to setting up an Ingress for your integration:

      #### Prerequisites

      1.  A running Kubernetes cluster.
      2.  `kubectl` configured to interact with your cluster.
      3.  An Ingress controller installed in your cluster. If you don't have one, you can install the popular [NGINX Ingress Controller](https://kubernetes.github.io/ingress-nginx/deploy/).

      #### 1. Create an Ingress Manifest

      First, you need to create a YAML file for the Ingress resource. This file will define rules for routing external HTTP(S) traffic to the integration's service.

      Create a file named `ingress.yaml` with the following content. Make sure to replace `<YOUR_DOMAIN>` with the domain you want to use to expose your integration. The service name and port should match what is created by the Helm chart. By default, the service for `github-ocean` will be named `github-ocean` and it will be listening on port `80`.

      <CodeBlock language="yaml" title="ingress.yaml">
{`apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: github-ocean-ingress
  # If you are using the NGINX ingress controller, you might want to add annotations
  # For example, to use a specific ingress class:
  # annotations:
  #   kubernetes.io/ingress.class: "nginx"
spec:
  rules:
  - host: <YOUR_DOMAIN> # e.g., github-ocean.yourcompany.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: github-ocean # This should be the name of the service created by Helm
            port:
              number: 80 # This should be the port the service is exposed on`}
      </CodeBlock>

      :::note
      The service name `github-ocean` is the default when installing the chart with `helm upgrade --install github-ocean ...`. If you used a different release name, the service name will be `<YOUR_RELEASE_NAME>`. You can find the service name by running `kubectl get svc`.
      :::

      #### 2. Apply the Ingress Manifest

      Apply the manifest to your cluster using `kubectl`:

      ```bash
      kubectl apply -f ingress.yaml
      ```

      This will create the Ingress resource. The Ingress controller will then provision a load balancer or configure itself to route traffic to your integration's service.

      #### 3. Get the External IP or Hostname

      After a few moments, you can get the external IP address or hostname of the Ingress by running:

      ```bash
      kubectl get ingress github-ocean-ingress
      ```

      Look for the `ADDRESS` column in the output. This is the public URL for your integration.

      #### 4. Update GitHub Webhook

      Now that your integration is publicly accessible, you can use this URL to configure the webhook in GitHub. The `base_url` for the integration should be set to `http://<YOUR_DOMAIN>` or `https://<YOUR_DOMAIN>`.

      When you set the `integration.eventListener.type` to `WEBHOOK` and provide the `base_url` during the Helm installation, Ocean will attempt to automatically create the webhook in GitHub for you. If you are setting this up after installation, you may need to configure it manually in your GitHub App settings or re-run the Helm installation with the updated values.

    </TabItem>
    <TabItem value="nginx" label="Nginx"></TabItem>
</Tabs>
