# Create Jira Issue from Dependabot Alert

This self-service action shows how to create a Jira issue with a from dependapot alert that links the issue to a concerned service in Port.

## Use cases
* Automatically create Jira issues from Dependabot alerts.
* Add detailed metadata to Jira issues from Dependabot alerts.

## Prerequisites

1. [Port's GitHub app](https://github.com/apps/getport-io) needs to be installed
2. [Jira API token](https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account/) with permissions to create new issues
3. In your GitHub repository, [go to **Settings > Secrets**](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository) and add the following secrets:
    * JIRA_API_TOKEN - [Jira API token](https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account) generated by the user
    * JIRA_BASE_URL - The URL of your Jira organization
    * JIRA_USER_EMAIL - The email of the Jira user that owns the Jira API token
    * PORT_CLIENT_ID - Your port [client id]([How to get the credentials](https://docs.getport.io/build-your-software-catalog/sync-data-to-catalog/api/#find-your-port-credentials))
    * PORT_CLIENT_SECRET - Your port [client secret]([How to get the credentials](https://docs.getport.io/build-your-software-catalog/sync-data-to-catalog/api/#find-your-port-credentials))

4. Optional - Install Port's Jira integration [learn more](https://docs.getport.io/build-your-software-catalog/sync-data-to-catalog/project-management/jira/#installation)

:::tip Jira integration
This step is not required for this example, but it will create all the blueprint boilerplate for you, and also update the catalog in real time with the new issue created.
:::
5. In case you decided not to install the Jira integration, you will need to create a blueprint for the Jira Project and Jira Issue in Port.
<details>
<summary><b>Jira Project Blueprint (Click to expand)</b></summary>

```json showLineNumbers
  {
   "identifier": "jiraProject",
   "description": "A Jira project",
   "title": "Jira Project",
   "icon": "Jira",
   "schema": {
      "properties": {
         "url": {
            "title": "Project URL",
            "type": "string",
            "format": "url",
            "description": "URL to the project in Jira"
         },
         "totalIssues": {
            "title": "Total Issues",
            "type": "number",
            "description": "The total number of issues in the project"
         }
      },
      "required": []
   },
   "mirrorProperties": {},
   "calculationProperties": {},
   "aggregationProperties": {},
   "relations": {}
}
```
</details>

<details>
<summary><b>Jira Issue Blueprint (Click to expand)</b></summary>

```json showLineNumbers
  {
   "identifier": "jiraIssue",
   "title": "Jira Issue",
   "icon": "Jira",
   "schema": {
      "properties": {
         "url": {
            "title": "Issue URL",
            "type": "string",
            "format": "url",
            "description": "URL to the issue in Jira"
         },
         "status": {
            "title": "Status",
            "type": "string",
            "description": "The status of the issue"
         },
         "issueType": {
            "title": "Type",
            "type": "string",
            "description": "The type of the issue"
         },
         "components": {
            "title": "Components",
            "type": "array",
            "description": "The components related to this issue"
         },
         "assignee": {
            "title": "Assignee",
            "type": "string",
            "format": "user",
            "description": "The user assigned to the issue"
         },
         "reporter": {
            "title": "Reporter",
            "type": "string",
            "description": "The user that reported to the issue",
            "format": "user"
         },
         "creator": {
            "title": "Creator",
            "type": "string",
            "description": "The user that created to the issue",
            "format": "user"
         },
         "priority": {
            "title": "Priority",
            "type": "string",
            "description": "The priority of the issue"
         },
         "created": {
            "title": "Created At",
            "type": "string",
            "description": "The created datetime of the issue",
            "format": "date-time"
         },
         "updated": {
            "title": "Updated At",
            "type": "string",
            "description": "The updated datetime of the issue",
            "format": "date-time"
         }
      },
      "required": []
   },
   "mirrorProperties": {},
   "calculationProperties": {},
   "aggregationProperties": {},
   "relations": {
      "parentIssue": {
         "title": "Parent Issue",
         "target": "jiraIssue",
         "required": false,
         "many": false
      },
      "project": {
         "title": "Project",
         "description": "The Jira project that contains this issue",
         "target": "jiraProject",
         "required": false,
         "many": false
      },
      "subtasks": {
         "title": "Subtasks",
         "target": "jiraIssue",
         "required": false,
         "many": true
      }
   }
}
```
</details>

6. You have finished the [onboarding process](/quickstart) and created a `Service` blueprint from the onboarding steps. You can alternatively create the `Service` blueprint in Port using the schema below: 

<details>
<summary><b>Service Blueprint (Click to expand)</b></summary>

```json showLineNumbers
{
  "identifier": "service",
  "title": "Service",
  "icon": "Github",
  "schema": {
    "properties": {
      "readme": {
        "title": "README",
        "type": "string",
        "format": "markdown",
        "icon": "Book"
      },
      "url": {
        "title": "URL",
        "format": "url",
        "type": "string",
        "icon": "Link"
      },
      "language": {
        "icon": "Git",
        "type": "string",
        "title": "Language",
        "enum": [
          "GO",
          "Python",
          "Node",
          "React"
        ],
        "enumColors": {
          "GO": "red",
          "Python": "green",
          "Node": "blue",
          "React": "yellow"
        }
      },
      "slack": {
        "icon": "Slack",
        "type": "string",
        "title": "Slack",
        "format": "url"
      },
      "code_owners": {
        "title": "Code owners",
        "description": "This service's code owners",
        "type": "string",
        "icon": "TwoUsers"
      },
      "type": {
        "title": "Type",
        "description": "This service's type",
        "type": "string",
        "enum": [
          "Backend",
          "Frontend",
          "Library"
        ],
        "enumColors": {
          "Backend": "purple",
          "Frontend": "pink",
          "Library": "green"
        },
        "icon": "DefaultProperty"
      },
      "lifecycle": {
        "title": "Lifecycle",
        "type": "string",
        "enum": [
          "Production",
          "Experimental",
          "Deprecated"
        ],
        "enumColors": {
          "Production": "green",
          "Experimental": "yellow",
          "Deprecated": "red"
        },
        "icon": "DefaultProperty"
      },
      "locked_in_prod": {
        "icon": "DefaultProperty",
        "title": "Locked in Prod",
        "type": "boolean",
        "default": false
      },
      "locked_reason_prod": {
        "icon": "DefaultProperty",
        "title": "Locked Reason Prod",
        "type": "string"
      }
    },
    "required": []
  },
  "mirrorProperties": {},
  "calculationProperties": {},
  "aggregationProperties": {},
  "relations": {}
}
```
</details>

:::tip Mapping Dependabot Alerts to Service Blueprint
To effectively manage your Dependabot alerts, map them to your `service` blueprint in Port. This allows you to categorize and link alerts to the appropriate services within your catalog, enhancing visibility and traceability. 
Follow this [resource mapping guide](https://docs.getport.io/build-your-software-catalog/sync-data-to-catalog/git/github/examples/resource-mapping-examples#map-repositories-dependabot-alerts-and-code-scan-alerts) for detailed steps on how to map Dependabot alerts.
:::


## GitHub Workflow

Create the file `create-jira-issue-from-dependapot.yml` in the `.github/workflows` folder of your repository and copy the content of the workflow configuration below:

:::tip Dedicated repository
We recommend creating a dedicated repository for the workflows that are used by Port actions.
:::

<details>
<summary><b> Create Jira Issue from dependabot alert workflow (Click to expand)</b></summary>

```yaml showLineNumbers
name: Create Jira Issue from Dependabot Alert

on:
   workflow_dispatch:
      inputs:
         title:
            required: true
            type: string
         type:
            required: true
            type: string
         project:
            required: true
            type: string
         port_context:
            required: true
            type: string

jobs:
   create-jira-issue:
      runs-on: ubuntu-latest
      steps:
         - name: Checkout code
           uses: actions/checkout@v2

         - name: Login to Jira
           uses: atlassian/gajira-login@v3
           env:
              JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
              JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
              JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

         - name: Inform starting of Jira issue creation
           uses: port-labs/port-github-action@v1
           with:
              clientId: ${{ secrets.PORT_CLIENT_ID }}
              clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
              operation: PATCH_RUN
              runId: ${{ fromJson(inputs.port_context).run_id }}
              logMessage: "Creating a new Jira issue from Dependabot alert... ⛴️"

         - name: Create Jira issue
           id: create_jira
           uses: atlassian/gajira-create@v3
           with:
              project: ${{ inputs.project }}
              issuetype: ${{ inputs.type }}
              summary: "Dependabot Alert: ${{ inputs.title }}"
              description: |
                 **Severity**: ${{ fromJson(inputs.port_context).entity.properties.severity }}
                 **State**: ${{ fromJson(inputs.port_context).entity.properties.state }}
                 **Package Name**: ${{ fromJson(inputs.port_context).entity.properties.packageName }}
                 **Package Ecosystem**: ${{ fromJson(inputs.port_context).entity.properties.packageEcosystem }}
                 **Manifest Path**: ${{ fromJson(inputs.port_context).entity.properties.manifestPath }}
                 **Scope**: ${{ fromJson(inputs.port_context).entity.properties.scope }}
                 **GHSA ID**: ${{ fromJson(inputs.port_context).entity.properties.ghsaID }}
                 **CVE ID**: ${{ fromJson(inputs.port_context).entity.properties.cveID }}
                 **URL**: ${{ fromJson(inputs.port_context).entity.properties.url }}
                 **References**:
                 ${{ fromJson(inputs.port_context).entity.properties.references | join("\n") }}
              fields: |
                 {
                   "customfield_12345": "${{ fromJson(inputs.port_context).entity.properties.severity }}",
                   "labels": ["port-${{ fromJson(inputs.port_context).entity.identifier }}"]
                 }

         - name: Inform creation of Jira issue
           uses: port-labs/port-github-action@v1
           with:
              clientId: ${{ secrets.PORT_CLIENT_ID }}
              clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
              operation: PATCH_RUN
              link: ${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create_jira.outputs.issue }}
              runId: ${{ fromJson(inputs.port_context).run_id }}
              logMessage: |
                 Jira issue created! ✅
                 The issue ID is: ${{ steps.create_jira.outputs.issue }}

```
</details>

## Port Configuration

On the [self-service](https://app.getport.io/self-serve) page, create the Port action against the `Dependabot Alert` blueprint. This will trigger the GitHub workflow.

<details>
<summary><b> Create Jira Issue from Dependabot Alert (Click to expand)</b></summary>

:::tip Modification Required
Make sure to replace `<GITHUB_ORG>` and `<GITHUB_REPO>` with your GitHub organization and repository names respectively
:::

```json showLineNumbers
{
   "identifier": "create_jira_issue_from_dependabot",
   "title": "Create Jira Issue from Dependabot",
   "icon": "Jira",
   "description": "Creates a Jira issue from dependabot.",
   "trigger": {
      "type": "self-service",
      "operation": "DAY-2",
      "userInputs": {
         "properties": {
            "title": {
               "title": "Title",
               "description": "Title of the Jira issue",
               "icon": "Jira",
               "type": "string"
            },
            "type": {
               "title": "Type",
               "description": "Issue type",
               "icon": "Jira",
               "type": "string",
               "default": "Task",
               "enum": [
                  "Task",
                  "Story",
                  "Bug",
                  "Epic"
               ],
               "enumColors": {
                  "Task": "blue",
                  "Story": "green",
                  "Bug": "red",
                  "Epic": "pink"
               }
            },
            "issue": {
               "title": "Issue",
               "description": "The issue will being created",
               "icon": "Jira",
               "type": "string",
               "blueprint": "jiraIssue",
               "format": "entity"
            },
            "project": {
               "title": "Project",
               "description": "The issue will be created on this project",
               "icon": "Jira",
               "type": "string",
               "blueprint": "jiraProject",
               "format": "entity"
            }
         },
         "required": [
            "title",
            "type"
         ],
         "order": [
            "title",
            "type"
         ]
      },
      "blueprintIdentifier": "githubDependabotAlert"
   },
   "invocationMethod": {
      "type": "GITHUB",
      "org": "<GITHUB_ORG>",
      "repo": "<GITHUB_REPO>",
      "workflow": "create-jira-issue-from-dependapot.yml",
      "workflowInputs": {
         "title": "{{.inputs.\"title\"}}",
         "type": "{{.inputs.\"type\"}}",
         "issue": "{{.inputs.\"issue\"}}",
         "project": "{{.inputs.\"project\" | if type == \"array\" then map(.identifier) else .identifier end}}",
         "port_context": {
            "entity": "{{.entity.identifier}}",
            "run_id": "{{.run.id}}"
         }
      },
      "reportWorkflowStatus": true
   },
   "requiredApproval": false,
   "publish": true
}
```
</details>

## Let's test it

1. Trigger the action from Port's [Self Service hub](https://app.getport.io/self-serve)

2. Done! wait for the issue to be created in Jira

Congrats 🎉 You've created your first Jira issue from a Dependabot alert!
